const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
const path = require('path');

const app = express();
const port = 3000;

app.use(bodyParser.json());

const dbPath = path.join(__dirname, 'db.json');

// ✅ راوت التسجيل


app.get('/register', (req, res) => {
  // نقرأ الداتا الحالية
  let db = {};
  try {
    db = JSON.parse(fs.readFileSync(dbPath));
  } catch (err) {
    db = {};
  }

  // إذا الجهاز مسجل مسبقاً، نمنع الدخول
  if (db.isRegistered) {
    return res.status(403).send('❌ هذا الرابط لم يعد متاحاً');
  }

  // تسجيل بيانات الجهاز
  const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress;
  const userAgent = req.headers['user-agent'];

  db.device = { ip, userAgent };
  db.isRegistered = true;

  fs.writeFileSync(dbPath, JSON.stringify(db, null, 2));

  // تحويل مباشر إلى /data
  res.redirect('/data');
});



// ✅ راوت البيانات
app.get('/data', (req, res) => {
  const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress;
  const userAgent = req.headers['user-agent'];

  const db = JSON.parse(fs.readFileSync(dbPath));
  const saved = db.device;

  if (
    !db.isRegistered ||
    !saved ||
    saved.ip !== ip ||
    saved.userAgent !== userAgent
  ) {
    return res.status(403).json({ message: '❌ جهاز غير مصرح له بالدخول' });
  }

  // ✅ مصفوفة الجمل أو المعلومات
  const messages = [
  "يويوااايتي اموت عليج",
  "You Are My Whole world",
  "يا اول و آخر حب الي",
  "يا عمري و كل حياتي", 
  "يا اول  من يدخل كلبي و يبقى كاعد بيه",
  "سكنت فؤادي منذ اول نظرة، ولا زلت في لب الفؤاد تجوب",
  "وقل للباحثين عن عيوبكِ: ما البدر في ناقصه الا هلال",
  "كأنكِ تاخذين الورد شهيقاً و تخرجين العطر زفيراً، اتتنفسين جمالاً ؟",
  "عودتني سنين عمري شلون احبهن يوم يوم، علمتني لو جبل طايح عليّ اذكر عيونك و اكوم",
  "في حين هم يرونك فرداً انا اراك كوناً",
  "When i met you all i wanted to say: hey, could you Stay forever?",
  "I love the Chemical between us",
  "احبكِ للحد الذي يجعلني اتاسف على كل لحظة و دقيقة و ثانية مضت من عمري و لك تكوني برفقتي",
  "الشمس كلي يصاحب شعلة منهة، وترى وجنة حبيبي شعلة منهة، ثاري العين تكره شعلة، منهة مثل ماتكره الروح المنية",
  "الكون عيناكِ لا شمسٌ ولا قمرُ",
  "جان عبالي كل الورد مثل بعضه. بس هسة ادركت ان وردة عن وردة تفرق",
  "بنص كلبي مكانك مو بين اهلك",
  "مجانت عندي نقطة ضعف، عيونك منين اجتي ما اعرف",
  "إن غبتَ ... لم ألقَ إنسانًا يؤانسني. وإن حضرتَ فكُلُّ الناسِ قد حضرُوا",
  "ستبقى عيناك تربكني، مهما اعتدت رؤيتها، انتَ لست فقط تلك النجمة المضيئة بعتمتي، بل انتِ مجرتي",
  "ما دام اني وياج راسج ما اريده ينزل فد يوم. انتِ اميرة و خاف يوكع تاجج",
  "يا ريت الناس كلها تروح من بالي . و بس لانت و حلاتك تكعد كبالي",
  "الصباح الذي لا تسمع فيه صباح الخير ممن تحب. يبقى ليلاً حتى اشعار اخر",
  "مو يكولون دائما اكو ضوء بنهاية النفق ؟ . و الضوء الي اهدتني اياه الدنيا هي انتِ",
  "فكيف يجدب حرف انتَ ملهمه . و كيف تظمأ روح انتَ ساقيها",
  "لو يعلم الحب كم احبك لتمنى ان يكون حبيبي",
  "يا كل كلي كن لي ان لم تكن لي فمن لي",
  "ان كان الشوق ذنب فعيناك مغفرته",
  "و غداً القاك و اخبرك ان الاشواق لا تكتب",
  "في حلمي انتِ لي و في واقعي انتِ حلمي",
  "تبقين انتِ من يسكن الدقائق الاخيرة قبل نومي",
  "يا نائم الليل روحي فيك ساهرةٌ",
  "العيد وجهج و الفائزين عيوني ",
  "اذكر عبرنا بديرة بيها الغام ، و طاحت شعرة منك رحت اجيبنها ، و دست على اللغم ما فكرت بالموت ، فكرت بشعرة راسك شلون اردنها",
  "في صوته ذاب الجمال عذوبة. لله در الصوت ما احلاه ، لو لا مخافة ان يقال بانني. بالغت في وصف التي اهواه ، لحلفت قد خلق الكلام لأجله. والصمت حكم واجب لسواه",
  "لها حُكمَ لقمانٍ وصورةُ يوسفٍ ونَغمةُ داودٍ وعفةُ مريم، ولي حزنُ يعقوبٍ ووحشةُ يونسٍ، وآلامُ أيوبٍ وحَسرةُ آدمِ",
  "اظفرج چان لو ينكسر تبچين ،و يكلفج ليل كامل بيه يسرهج . ابچيلي الليلة هاي اني الي مكسور، ما معقولة اهم من عندي اظفرج",
  "هويتي وصورتك كل سفر هنّة وياي بوحدة اعبُر مُدن والثانية أيامي",
  "ما مرّ ذِكرُكَ إلاّ وابتسمتُ لهُ كأنكَ العيدُ والباقون أيّامُ أو حَامَ طيفُكَ إلاّ طِرتُ أتبعُهُ أنتَ الحقيقةُ والجلّاسُ أوهامُ",
  "رفقا علينا يا مليحة إننا قوم إذا زاد الهيام تعذبوا",
  "غب ما تشاء فما عليك عتاب . وارجع فمن حق الحبيب إياب . أنا لا ارد بباب قلبي عابرًا . أو كيف لو وقفوا به أحبابُ . إن لم تجد في الكون بابًا للهوى ، فأنا وقلبي كلنا أبوابُ",
  "أرْبَعينُكِ يتكاثرون! في طريقي اليوم رأيتُ الكثيرَ منك ، وأظنُّ أنِّي قد وصلتُ الرّقمَ تسعين، وبعدها تعبتُ مِن العدِّ ! كُفِّ عنْ نَثرِ ملامِحُكِ على وجوه العابرين",
  "و لَعَلَّنا مِنْ بَعْدِ بُعْدٍ نلتقي و يطيبُ قلبي عندَما ألقاك و يراكِ بعضُ الناسِ شخصاً عابراً و أنا أراك حبيبي و ملاكي",
  "اميرتهن تره المفروض تتقدس تفاصيلج وارتب شعرج بـ أيدي وابوس ايدج واغنيلج واذا صابج تعب نامي حبيبج باقي يدعيلج",
  "أمس بالليل طيفك مر بالعيون وكعدت وياك ساعة وعاتبتك فجأة وراح طيفك وفزت الروح كلبت الليل كله ومالكيتك",
  "رماكَ الحاسِدون بكُل عيب، وعيبّك أن حُسنك لا يُعاب.",
  "لَو مالَ قلبي عَنْ هَواكَ نَزعتُهُ وَ شَرَيتُ قَلباً فِي هَواكَ يَذوبُ آياتُ حُبِّكَ في فؤادي أُحكِمَتْ مَنْ قالَ أنّي عَن هواكَ أتوبُ",
  "وعذرته لما تساقط دمعهُ. ونسيت أياماً بها أبكاني. وأخذته في الحضن أهمس راجياً. جمرات دمعك أيقظت نيراني. أتريد قتلي مرتين ألا كفى. فامنع دموعك واحترم أحزاني",
  "يقولون يخلق من الشبه أربعين وانا اعلم أن تسعا وثلاثين امرأة اتخذت هذا القول ذريعة ليتشبهن بك",
  "في بحرَ عيّنيكِ هامت كُلُّ أشواقي، يا رّبة الحُسن هل تنوينَ إغراقِي؟، ما كنت أؤمن بالعيون وفعلها، حتى دهتني في الهوى عيناكِ، عيناكِ بحرٌ تاهت به سفني، وتزعزت به نبضاتُ قلبي وأنفاسي، أنا الذي لا يهزني برقٌ ولا رعدٌ، أعينين متلألئةٌ تهزمُ ثباتي ؟",
  "رجل وما استسلمْتُ قَبْلُ لفارسٍ، مالي أمام عيونها مستسلِمُ !؟، لي ألف بيتٍ بالفصيح أجدْتُها، لكنني في حبها أتلعثمُ !",
  "ﻏﻴﺪﺍﺀ ﻓﻲ ﺍﻟﺤﺴﻦ ﻻ ﺑﺪﺭ ﻳﻀﺎﻫﻴﻬﺎ ﻭﺍﻟﺨﺎﻝ ﺃﺳﻮﺩ ﻏﺮﺑﻴﺐ ﺑﻀﺎﺣﻴﻬﺎ ﻛﺄﻧﻬﺎ ﺍﻟﺸﻤﺲ ﻓﻲ ﺿﺤﻮﺍﺀ ﺻﺎﺣﻴﺔ ﺑﺒﺎﻧﺔ ﻭﺍﻟﺪﺟﻲ ﻏﻄﻲ ﺃﻋﺎﻟﻴﻬﺎ",
  "چفك راهم لچفي مثل طرفين سحابة",
  "إني تُهت بغرامك وتاه كُلي فكيف أهربُ مِنك وأنتَ ظلّي لا غايةَ لي بأحدٍ فأنتَ غايتي وأنا الضعيف بهواك قُل لي كيف أحيا بدونك وأنت مني؟",
  "بيوم ١١/١١ اكثر شي جنت افكر بيه هو هذا: أخاف أن أحبك جداً فأفقدك ثم أتألم وأخاف أيضاً أن لا أحبك فتضيع فرصة الحب فأندم أخبرني كيف أحبك بلا ألم و كيف لا أحبك بلا ندم؟",
  "ولقد رأيتُكَ في منامي ليلةً فنَسيتُ ما قد كانَ مِن أحزانِ وحَسِبتُ نومي في حضوركَ يقظةً حتى أَفَـقْتُ على فراقٍ ثانِ",
  "وضِيئةُ الوجهِ لا بدرٌ يُشابِهُها مُحمرَّة الثَّغرِ لا وردٌ يُدانِيها بيضَاءُ حمراءُ لا وصفٌ يُطابِقُها كأنَّها الشَّمسُ قَد مالت خطاوِيها",
  "مدري شلون اشوفك وانت جوة الروح واكول لروحي يمك خل توديني نص دين البشر لو رادو يكملون وانه وياك كملت كل ديني تداوي الروح بيدك وبيدي أمرض الروح حتى النوب هم ترجع تداويني يم العين اشوفك وانت ما موجود واحسك تمشي دم بنص شراييني واشوفك انت انه وانه انت تصير واذا اشتاك بس اصفن واحاجيني.",
  "لا السيفُ يفعلُ بي ما أنتِ فاعلةٌ .. ولا لقاءُ عدوَّي مثلَ لُقياكِ ، لو باتَ سهمٌ من الأعداءِ في كَبدي .. ما نالَ مِنَّيَ ما نالتْهُ عيناكِ.",
  "عَيْنَاكِ غَابَتَا نَخِيلٍ سَاعَةَ السَّحَرْ ، أو شُرْفَتَانِ رَاحَ يَنْأَى عَنْهُمَا القَمَرْ . عَيْنَاكِ حِينَ تَبْسُمَانِ تُورِقُ الكُرُومْ وَتَرْقُصُ الأَضْوَاءُ ...كَالأَقْمَارِ في نَهَرْ يَرُجُّهُ المِجْدَافُ وَهْنَاً سَاعَةَ السَّحَرْ"
];
  // ✅ اختيار عشوائي
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];

  res.json({
    message: randomMessage
  });
});



app.listen(port, () => {
  console.log(`✅ API شغّال على http://localhost:${port}`);
});
